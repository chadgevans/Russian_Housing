Russian Housing Analysis
================

This is an extremely rich data set with features that are not anonymized, so it makes an excellent playground for exploratory data analysis. Between the train data and the macro data there are hundreds of variables. Although we obviously can't explore everything, I want to cover as much as is possible and interesting.

Training Data

-   [Missing Data](#missing)
-   [Data Quality Issues](#quality)
-   [Internal Home Features](#internal)
-   [Demographic Features](#demographic)
-   [Education Features](#school)
-   [Cultural/Recreational Features](#culture)
-   [Infrastructure Features](#infrastructure)
-   [Variable Importance](#importance)

Train/Test Comparison

-   [Missing Data](#missing_test)
-   [Internal Features](#internal_test)

``` r
library(data.table)
library(tidyverse)
library(lubridate)
library(scales)
library(corrplot)
library(DT)
```

Training Data
=============

``` r
dtrain <- fread('../data/train.csv', stringsAsFactors=TRUE)
```

Missing Data
------------

How much data is missing?

``` r
miss_pct <- map_dbl(dtrain, function(x) { round((sum(is.na(x)) / length(x)) * 100, 1) })

miss_pct <- miss_pct[miss_pct > 0]

data.frame(miss=miss_pct, var=names(miss_pct), row.names=NULL) %>%
ggplot(aes(x=reorder(var, -miss), y=miss)) +
geom_bar(stat='identity', fill='red') +
labs(x='', y='% missing', title='Percent missing data by feature') +
theme(axis.text.x=element_text(angle=90, hjust=1))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-3-1.png)

Of 292 columns, 51 have missing values. The percentage of values missing ranges from 0.1% in metro\_min\_walk to 47.4% in hospital\_beds\_raion.

Data Quality Issues
-------------------

Below I am fixing a number of data issues in train.csv which have been brought up by others in the forums or that I have discovered.

``` r
# state should be discrete valued between 1 and 4. There is a 33 in it that is cleary a data entry error
# Lets just replace it with the mode.
dtrain$state[dtrain$state == 33] <- which.max(table(dtrain$state))

# build_year has an erronus value 20052009. Since its unclear which it should be, let's replace with 2007
dtrain$build_year[dtrain$build_year == 20052009] <- 2007
```

Housing Internal Characteristics
--------------------------------

Let's look for correlation among the internal home characteristics and price.

``` r
# variables that are internal to home
internal_chars <- c('full_sq', 'life_sq', 'floor', 'max_floor', 'build_year', 'num_room',
'kitch_sq', 'state', 'price_doc')

corrplot(cor(dtrain[, ..internal_chars], use="complete.obs"))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-5-1.png)

### Area of Home and Number of Rooms

We saw earlier that full\_sq is correlated with price. Let's take a closer look.

``` r
ggplot(aes(x=full_sq, y=price_doc), data=dtrain) +
geom_point(color='red')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-6-1.png)

There is an outlier in full\_sq. Its not clear whether this is an entry error. For now, remove it.

``` r
dtrain %>%
filter(full_sq < 2000) %>%
ggplot(aes(x=full_sq, y=price_doc)) +
geom_point(color='red', alpha=0.5) +
labs(x='Area', y='Price', title='Price by area in sq meters')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-7-1.png)

The feature full\_sq is defined in the data dictionary as 'total area in square meters, including loggias, balconies and other non-residential areas' and the life\_sq is defined as 'living area in square meters, excluding loggias, balconies and other non-residential areas.' So it should be the case that life\_sq is always less than full\_sq.

``` r
sum(dtrain$life_sq > dtrain$full_sq, na.rm=TRUE)
```

    ## [1] 37

There are 37 observations where life\_sq is greater than full\_sq.

Let's look at num\_rooms.

``` r
table(dtrain$num_room)
```

    ## 
    ##    0    1    2    3    4    5    6    7    8    9   10   17   19 
    ##   14 7602 8132 4675  418   40    9    1    3    1    2    1    1

``` r
ggplot(aes(x=num_room), data=dtrain) +
geom_histogram(fill='red', bins=20) +
ggtitle('Distribution of room count')
```

    ## Warning: Removed 9572 rows containing non-finite values (stat_bin).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-9-1.png)

A vast majority of the apartments have three rooms or less.

### Sale Type

Is there a significant difference in price for homes bought by an owner-occupier or homes bought for investment?

``` r
ggplot(aes(x=price_doc), data=dtrain) +
geom_density(fill='red', color='red') +
facet_grid(~product_type) +
scale_x_continuous(trans='log')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-10-1.png)

``` r
dtrain %>% group_by(product_type) %>% summarize(median(price_doc))
```

    ## # A tibble: 2 x 2
    ##    product_type `median(price_doc)`
    ##          <fctr>               <dbl>
    ## 1    Investment             6670000
    ## 2 OwnerOccupier             5564090

It's not clear from the density plots, but homes sold for investment sell for more than homes sold to owner-occupiers.

### Build Year

Let's take a look at build\_year:

``` r
table(dtrain$build_year)
```

    ## 
    ##    0    1    3   20   71  215 1691 1860 1876 1886 1890 1895 1896 1900 1904 
    ##  530  368    2    1    1    1    1    2    1    1    5    1    2    2    1 
    ## 1905 1906 1907 1910 1911 1912 1914 1915 1917 1920 1924 1925 1926 1927 1928 
    ##    1    1    2    5    1    5    3    5   16    1    3    1    8   10   12 
    ## 1929 1930 1931 1932 1933 1934 1935 1936 1937 1938 1939 1940 1941 1943 1946 
    ##   12    6    6    8    7   13   11    5   10    9    7   14    2    2    2 
    ## 1947 1948 1949 1950 1951 1952 1953 1954 1955 1956 1957 1958 1959 1960 1961 
    ##    4    1    3   22   23   45   24   36   52   48  119  179  208  344  297 
    ## 1962 1963 1964 1965 1966 1967 1968 1969 1970 1971 1972 1973 1974 1975 1976 
    ##  338  325  315  378  348  384  389  407  418  352  360  333  357  309  263 
    ## 1977 1978 1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 
    ##  260  235  236  226  189  189  185  169  178  131  171  155  155  129   93 
    ## 1992 1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 
    ##  139  115  160  149  162  139  141  125  130  177  214  193  220  176  242 
    ## 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 4965 
    ##  220  234  176  132  162  233  464  919  824  375  154    1    1

There are a number of nonsensical years - 0, 1, 3, 20, 71, 215, 2018, and 4965. The 1691 I guess is possible. In another kernel, I plan on setting these to NA and using the mice package to impute these values. For now, let's limit our visualizations to the reasonable years:

``` r
dtrain %>%
filter(build_year > 1691 & build_year < 2018) %>%
ggplot(aes(x=build_year)) +
geom_histogram(fill='red') +
ggtitle('Distribution of build year')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-12-1.png)

The distribution appears bimodal with a peak somewhere in the early 1970s and somewhere in the past few years.

Now let's see if build\_year and prices are related. Here I group the data by year and take the mean of price\_doc.

``` r
dtrain %>%
filter(build_year > 1691 & build_year < 2018) %>%
group_by(build_year) %>%
summarize(mean_build_price=mean(price_doc)) %>%
ggplot(aes(x=build_year, y=mean_build_price)) +
geom_line(stat='identity', color='red') +
geom_smooth(color='darkgrey') +
ggtitle('Mean price by year of build')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-13-1.png)

The relationship appears somewhat steady over time, especially after 1960. There is some volatility in the earlier years. This is not a real effect but simply due to the sparseness of observations until around 1950.

### Timestamp

How does the sale price vary over the time horizon of the data set? Here I just group by the day and caclulate the median price for each day and plot it over time.

``` r
dtrain$timestamp <- as.Date(dtrain$timestamp)

dtrain %>%
group_by(timestamp) %>%
summarize(med_price = median(price_doc)) %>%
ggplot(aes(x = timestamp, y = med_price)) +
geom_line(color = 'red') +
geom_smooth(method = 'lm', color = 'grey', alpha = 0.7) +
ggtitle('Daily median price over time')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-14-1.png)

And to compare with the above plot, here is the volume of sales over the same time.

``` r
dtrain %>%
group_by(timestamp) %>%
summarize(n = n()) %>%
ggplot(aes(x = timestamp, y = n)) +
geom_bar(stat = 'identity') +
labs(x='', y='Number of transactions', title='Sales volume over time')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-15-1.png)

Is there a seasonal component to home prices in the course of a year?

``` r
dtrain %>%
mutate(month=month(timestamp)) %>%
group_by(month) %>%
summarize(med_price=median(price_doc)) %>%
ggplot(aes(x=as.integer(month), y=med_price)) +
geom_line(color='red', stat='identity') +
geom_point(color='red', size=2) +
scale_x_continuous(breaks=seq(1,12,1)) +
labs(x='Month', title='Price by month of year')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-16-1.png)

### Home State/Material

How do homes vary in price by condition?

``` r
dtrain %>%
filter(!is.na(state)) %>%
ggplot(aes(x=as.factor(state), y=log10(price_doc))) +
geom_jitter(color='grey', alpha=0.2) +
geom_violin(fill='red', alpha=0.7) +
ggtitle('Log10 of median price by state of home')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-17-1.png)

It's hard to tell from the plot, but it does appear that state 4 has the highest sale price on average. Significantly fewer homes fall under this category however. Let's check:

``` r
dtrain %>%
filter(!is.na(state)) %>%
group_by(state) %>%
summarize(mean(price_doc))
```

    ## # A tibble: 4 x 2
    ##   state `mean(price_doc)`
    ##   <int>             <dbl>
    ## 1     1           7315440
    ## 2     2           7060396
    ## 3     3           8078316
    ## 4     4          13345469

State 4 has the highest average price by far, followed by state 3. State 1 and 2 are close.

What about the material feature?

``` r
table(dtrain$material)
```

    ## 
    ##     1     2     3     4     5     6 
    ## 14197  2993     1  1344  1561   803

It's unclear what these values mean since this feature is not described in the data dictionary. Material 1 is by far the most common. Only one home is classifed as material 3. How does median price compare among these six materials?

``` r
dtrain %>%
filter(!is.na(material)) %>%
ggplot(aes(x=as.factor(material), y=log(price_doc))) +
geom_jitter(alpha=0.4, color='grey') +
geom_violin(fill='red', color='red',  alpha=0.6) +
ggtitle('Distribution of price by build material')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-20-1.png)

Using a log scale for the price makes this plot a lot more informative, but what about the raw prices?

``` r
dtrain %>%
filter(!is.na(material)) %>%
group_by(state=as.factor(material)) %>%
summarize(med_price=median(price_doc))
```

    ## # A tibble: 6 x 2
    ##    state med_price
    ##   <fctr>     <dbl>
    ## 1      1   6500000
    ## 2      2   6900000
    ## 3      3   6931143
    ## 4      4   7247870
    ## 5      5   6492000
    ## 6      6   6362318

There is not much difference, but state 4 seems to be the most expensive.

### Floor of Home

How does the floor feature compare with price? According to the correlation plot from earlier, there is a moderate positive correlation.

``` r
ggplot(aes(x=floor, y=log(price_doc)), data=dtrain) +
geom_point(color='red', alpha=0.4) +
geom_smooth(method='lm', color='darkgrey') +
ggtitle('Price by floor of home')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-22-1.png)

On a whole, price seems to rise with the floor, although the effect is pretty small. Along the same lines, I wonder if the height of building is correlated with price. Well look at this using max\_floor as a proxy for height.

``` r
ggplot(aes(x=max_floor, y=log(price_doc)), data=dtrain) +
geom_point(color='red', alpha=0.4) +
geom_smooth(method='lm', color='darkgrey')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-23-1.png)

Again a small positive correlation. This effect however is likely being confounded by the fact that the urban core has both more expensive real estate and taller buildings. So the height of the building alone is likely not what is determing price here.

Let's check the quality of the data and see if floor is greater than max\_floor for any observations:

``` r
ggplot(aes(x=floor, y=max_floor), data=dtrain) +
geom_point(color='red') +
geom_abline(slope=1, intercept=0, color='grey')
```

    ## Warning: Removed 9572 rows containing missing values (geom_point).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-24-1.png)

The observations below the grey identity line have a floor greater than the number of floors in the building. That's not good. How many are there?

``` r
dtrain %>%
select(id, floor, max_floor) %>%
filter(floor > max_floor) %>%
datatable()
```

<!--html_preserve-->

<script type="application/json" data-for="htmlwidget-065e82bc35a3c2ec7df1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672","673","674","675","676","677","678","679","680","681","682","683","684","685","686","687","688","689","690","691","692","693","694","695","696","697","698","699","700","701","702","703","704","705","706","707","708","709","710","711","712","713","714","715","716","717","718","719","720","721","722","723","724","725","726","727","728","729","730","731","732","733","734","735","736","737","738","739","740","741","742","743","744","745","746","747","748","749","750","751","752","753","754","755","756","757","758","759","760","761","762","763","764","765","766","767","768","769","770","771","772","773","774","775","776","777","778","779","780","781","782","783","784","785","786","787","788","789","790","791","792","793","794","795","796","797","798","799","800","801","802","803","804","805","806","807","808","809","810","811","812","813","814","815","816","817","818","819","820","821","822","823","824","825","826","827","828","829","830","831","832","833","834","835","836","837","838","839","840","841","842","843","844","845","846","847","848","849","850","851","852","853","854","855","856","857","858","859","860","861","862","863","864","865","866","867","868","869","870","871","872","873","874","875","876","877","878","879","880","881","882","883","884","885","886","887","888","889","890","891","892","893","894","895","896","897","898","899","900","901","902","903","904","905","906","907","908","909","910","911","912","913","914","915","916","917","918","919","920","921","922","923","924","925","926","927","928","929","930","931","932","933","934","935","936","937","938","939","940","941","942","943","944","945","946","947","948","949","950","951","952","953","954","955","956","957","958","959","960","961","962","963","964","965","966","967","968","969","970","971","972","973","974","975","976","977","978","979","980","981","982","983","984","985","986","987","988","989","990","991","992","993","994","995","996","997","998","999","1000","1001","1002","1003","1004","1005","1006","1007","1008","1009","1010","1011","1012","1013","1014","1015","1016","1017","1018","1019","1020","1021","1022","1023","1024","1025","1026","1027","1028","1029","1030","1031","1032","1033","1034","1035","1036","1037","1038","1039","1040","1041","1042","1043","1044","1045","1046","1047","1048","1049","1050","1051","1052","1053","1054","1055","1056","1057","1058","1059","1060","1061","1062","1063","1064","1065","1066","1067","1068","1069","1070","1071","1072","1073","1074","1075","1076","1077","1078","1079","1080","1081","1082","1083","1084","1085","1086","1087","1088","1089","1090","1091","1092","1093","1094","1095","1096","1097","1098","1099","1100","1101","1102","1103","1104","1105","1106","1107","1108","1109","1110","1111","1112","1113","1114","1115","1116","1117","1118","1119","1120","1121","1122","1123","1124","1125","1126","1127","1128","1129","1130","1131","1132","1133","1134","1135","1136","1137","1138","1139","1140","1141","1142","1143","1144","1145","1146","1147","1148","1149","1150","1151","1152","1153","1154","1155","1156","1157","1158","1159","1160","1161","1162","1163","1164","1165","1166","1167","1168","1169","1170","1171","1172","1173","1174","1175","1176","1177","1178","1179","1180","1181","1182","1183","1184","1185","1186","1187","1188","1189","1190","1191","1192","1193","1194","1195","1196","1197","1198","1199","1200","1201","1202","1203","1204","1205","1206","1207","1208","1209","1210","1211","1212","1213","1214","1215","1216","1217","1218","1219","1220","1221","1222","1223","1224","1225","1226","1227","1228","1229","1230","1231","1232","1233","1234","1235","1236","1237","1238","1239","1240","1241","1242","1243","1244","1245","1246","1247","1248","1249","1250","1251","1252","1253","1254","1255","1256","1257","1258","1259","1260","1261","1262","1263","1264","1265","1266","1267","1268","1269","1270","1271","1272","1273","1274","1275","1276","1277","1278","1279","1280","1281","1282","1283","1284","1285","1286","1287","1288","1289","1290","1291","1292","1293","1294","1295","1296","1297","1298","1299","1300","1301","1302","1303","1304","1305","1306","1307","1308","1309","1310","1311","1312","1313","1314","1315","1316","1317","1318","1319","1320","1321","1322","1323","1324","1325","1326","1327","1328","1329","1330","1331","1332","1333","1334","1335","1336","1337","1338","1339","1340","1341","1342","1343","1344","1345","1346","1347","1348","1349","1350","1351","1352","1353","1354","1355","1356","1357","1358","1359","1360","1361","1362","1363","1364","1365","1366","1367","1368","1369","1370","1371","1372","1373","1374","1375","1376","1377","1378","1379","1380","1381","1382","1383","1384","1385","1386","1387","1388","1389","1390","1391","1392","1393","1394","1395","1396","1397","1398","1399","1400","1401","1402","1403","1404","1405","1406","1407","1408","1409","1410","1411","1412","1413","1414","1415","1416","1417","1418","1419","1420","1421","1422","1423","1424","1425","1426","1427","1428","1429","1430","1431","1432","1433","1434","1435","1436","1437","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1448","1449","1450","1451","1452","1453","1454","1455","1456","1457","1458","1459","1460","1461","1462","1463","1464","1465","1466","1467","1468","1469","1470","1471","1472","1473","1474","1475","1476","1477","1478","1479","1480","1481","1482","1483","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493"],[8219,8271,8502,8534,8915,9164,9260,9312,9391,9415,9426,9445,9455,9485,9564,9692,9699,9727,9767,9825,9858,9913,9925,9972,9998,10082,10089,10115,10138,10145,10154,10173,10192,10217,10222,10226,10227,10232,10265,10279,10290,10297,10304,10308,10326,10333,10334,10348,10350,10352,10365,10402,10407,10437,10441,10455,10458,10462,10468,10473,10478,10492,10498,10510,10514,10525,10527,10547,10588,10607,10612,10614,10619,10620,10630,10631,10634,10644,10656,10666,10668,10671,10675,10689,10691,10702,10709,10714,10718,10721,10727,10751,10760,10766,10781,10786,10795,10812,10822,10825,10852,10877,10887,10891,10913,10917,10919,10924,10933,10941,10955,10987,10990,10996,10999,11022,11023,11026,11036,11044,11045,11075,11084,11086,11090,11095,11097,11103,11110,11113,11115,11119,11125,11159,11186,11188,11191,11194,11198,11199,11205,11231,11239,11243,11249,11252,11256,11258,11274,11304,11312,11338,11341,11344,11367,11370,11382,11384,11386,11393,11400,11409,11460,11466,11494,11495,11504,11517,11519,11534,11556,11576,11616,11628,11641,11653,11655,11656,11665,11687,11688,11726,11731,11756,11760,11788,11794,11910,11916,11945,11974,11992,11999,12043,12048,12050,12059,12151,12164,12166,12174,12177,12181,12182,12186,12204,12205,12213,12222,12223,12249,12276,12298,12314,12315,12318,12319,12327,12342,12383,12402,12410,12419,12433,12443,12483,12518,12541,12553,12607,12621,12707,12708,12720,12722,12727,12729,12734,12739,12740,12757,12764,12770,12798,12811,12812,12829,12865,12873,12906,12933,12934,12948,12956,12964,12968,12976,12984,12986,13003,13006,13020,13078,13088,13104,13120,13130,13159,13166,13197,13219,13241,13274,13282,13284,13290,13306,13325,13329,13337,13345,13384,13444,13445,13458,13461,13467,13503,13564,13584,13598,13620,13642,13645,13650,13685,13693,13738,13743,13780,13809,13813,13821,13831,13840,13898,13908,13911,13938,13943,13954,13957,14064,14103,14119,14126,14132,14138,14149,14204,14239,14259,14278,14290,14295,14299,14391,14394,14408,14434,14487,14498,14507,14523,14525,14527,14537,14539,14550,14573,14588,14614,14621,14633,14663,14684,14686,14707,14768,14774,14785,14817,14832,14849,14893,14907,14910,14911,14966,14967,14973,14974,14981,15001,15010,15029,15031,15032,15064,15082,15107,15124,15133,15157,15165,15180,15192,15220,15227,15280,15294,15305,15327,15351,15356,15368,15462,15469,15493,15511,15518,15521,15530,15536,15557,15574,15579,15611,15627,15633,15638,15649,15654,15664,15665,15702,15705,15707,15769,15790,15825,15923,15928,15936,15976,15990,15995,16031,16071,16103,16118,16119,16132,16155,16170,16175,16193,16194,16276,16277,16285,16293,16319,16338,16406,16437,16498,16502,16536,16537,16555,16558,16625,16629,16650,16669,16670,16678,16682,16698,16714,16725,16728,16734,16745,16751,16762,16779,16797,16816,16834,16835,16844,16850,16908,16916,16930,16944,16951,16968,16972,16990,17022,17026,17053,17062,17072,17090,17093,17129,17144,17168,17172,17183,17186,17187,17208,17216,17223,17236,17270,17275,17290,17303,17319,17367,17394,17396,17428,17439,17465,17467,17490,17494,17520,17532,17551,17575,17576,17579,17602,17633,17636,17655,17693,17757,17763,17769,17771,17776,17797,17803,17805,17808,17811,17824,17834,17848,17872,17875,17878,17883,17915,17924,17933,17955,17959,17966,17983,18020,18036,18038,18039,18065,18067,18080,18113,18120,18157,18178,18198,18200,18201,18214,18217,18219,18234,18242,18247,18262,18263,18276,18278,18316,18320,18325,18330,18350,18376,18432,18470,18514,18520,18542,18559,18566,18589,18621,18625,18640,18649,18681,18689,18695,18696,18699,18727,18746,18756,18767,18769,18796,18803,18841,18854,18904,18911,18966,18967,18995,19026,19032,19063,19091,19155,19181,19191,19196,19214,19226,19232,19236,19249,19265,19271,19277,19281,19286,19296,19310,19323,19328,19345,19355,19359,19364,19367,19372,19377,19392,19449,19450,19466,19467,19478,19552,19553,19564,19570,19573,19586,19590,19592,19604,19611,19625,19626,19652,19654,19659,19663,19674,19677,19741,19745,19746,19762,19768,19783,19785,19787,19793,19795,19822,19832,19841,19845,19846,19849,19867,19904,19909,19954,19964,19974,19996,20018,20044,20062,20064,20089,20091,20092,20111,20115,20118,20139,20156,20179,20197,20198,20200,20229,20231,20238,20240,20250,20255,20257,20266,20278,20286,20307,20333,20354,20365,20388,20390,20391,20392,20401,20433,20443,20451,20462,20507,20511,20531,20540,20548,20552,20560,20563,20569,20574,20577,20582,20596,20607,20610,20611,20624,20633,20651,20672,20673,20674,20679,20688,20700,20701,20706,20708,20709,20721,20723,20735,20743,20744,20768,20776,20795,20809,20816,20818,20819,20821,20830,20849,20855,20857,20861,20863,20878,20922,20945,20949,20958,20980,21013,21037,21049,21089,21118,21166,21305,21353,21375,21377,21383,21387,21402,21404,21418,21437,21442,21448,21452,21465,21473,21476,21482,21486,21503,21511,21515,21523,21527,21544,21555,21560,21561,21562,21567,21569,21576,21584,21587,21600,21604,21627,21641,21651,21653,21667,21669,21681,21684,21693,21702,21705,21714,21725,21736,21742,21756,21765,21778,21782,21820,21841,21847,21848,21882,21905,21909,21916,21925,21932,21946,21952,21993,21996,21998,22017,22024,22038,22046,22051,22064,22078,22088,22092,22109,22113,22117,22137,22138,22169,22177,22180,22218,22228,22236,22238,22241,22249,22268,22300,22306,22322,22325,22326,22336,22340,22342,22357,22359,22397,22406,22423,22434,22445,22448,22449,22458,22465,22473,22484,22513,22537,22554,22555,22557,22559,22574,22578,22582,22585,22593,22595,22602,22621,22622,22652,22680,22687,22693,22696,22700,22701,22726,22749,22779,22789,22802,22821,22822,22826,22841,22855,22864,22897,22904,22907,22936,22938,22946,22949,22980,22995,23009,23014,23017,23029,23035,23083,23087,23090,23093,23094,23095,23137,23139,23153,23161,23163,23165,23207,23218,23230,23271,23320,23328,23350,23377,23378,23391,23392,23393,23401,23405,23460,23483,23488,23492,23496,23500,23504,23546,23549,23559,23587,23591,23592,23597,23613,23628,23634,23635,23650,23651,23704,23721,23724,23737,23741,23763,23780,23806,23826,23830,23835,23866,23867,23870,23892,23895,23918,23929,23954,23956,23989,23991,24007,24019,24035,24040,24044,24046,24051,24053,24083,24087,24113,24116,24120,24124,24146,24150,24155,24171,24186,24210,24217,24228,24229,24238,24239,24256,24274,24280,24289,24291,24323,24332,24341,24348,24352,24353,24354,24378,24380,24387,24390,24393,24397,24403,24405,24418,24423,24442,24514,24532,24539,24552,24565,24574,24581,24589,24592,24594,24600,24632,24646,24668,24673,24675,24682,24685,24713,24718,24732,24737,24746,24859,24860,24895,24897,24911,24926,24951,24963,24986,24992,24997,25011,25050,25053,25057,25066,25070,25073,25095,25097,25105,25126,25164,25166,25172,25206,25232,25245,25252,25288,25294,25306,25318,25341,25349,25365,25369,25386,25394,25405,25442,25458,25462,25464,25471,25502,25507,25512,25535,25554,25567,25591,25604,25617,25621,25649,25653,25695,25715,25717,25721,25722,25728,25761,25782,25809,25827,25834,25857,25860,25861,25862,25882,25886,25890,25911,25917,25925,25939,25949,25955,25958,26002,26009,26019,26053,26085,26099,26110,26117,26128,26133,26156,26157,26164,26180,26196,26203,26231,26236,26261,26266,26298,26306,26328,26336,26373,26405,26407,26428,26437,26438,26453,26469,26475,26479,26484,26513,26517,26520,26522,26536,26554,26558,26570,26573,26627,26654,26656,26676,26687,26690,26705,26708,26717,26729,26735,26801,26841,26844,26878,26900,26928,26951,26956,27009,27046,27050,27057,27085,27118,27138,27141,27149,27152,27166,27171,27178,27225,27230,27238,27243,27249,27312,27334,27346,27359,27380,27383,27404,27410,27416,27444,27461,27463,27470,27479,27491,27499,27539,27548,27560,27657,27668,27726,27748,27750,27765,27828,27840,27854,27855,27857,27876,27884,27896,27919,27932,27956,27990,27991,28000,28006,28011,28016,28018,28021,28065,28094,28096,28098,28102,28125,28126,28135,28155,28171,28178,28192,28196,28219,28251,28272,28278,28294,28297,28304,28314,28350,28358,28373,28379,28380,28386,28394,28395,28407,28421,28424,28445,28459,28470,28482,28483,28496,28521,28523,28530,28531,28548,28553,28556,28558,28567,28575,28582,28592,28596,28597,28628,28631,28633,28634,28637,28640,28650,28654,28699,28710,28713,28732,28743,28767,28802,28828,28829,28834,28847,28848,28856,28871,28880,28881,28897,28905,28909,28915,28927,28943,28950,28988,28999,29005,29023,29027,29030,29043,29045,29054,29074,29076,29084,29105,29112,29166,29172,29176,29188,29198,29200,29206,29211,29237,29252,29257,29283,29298,29309,29315,29317,29333,29337,29394,29416,29441,29443,29456,29470,29477,29478,29485,29502,29505,29521,29529,29530,29538,29547,29565,29570,29571,29575,29578,29580,29588,29599,29618,29626,29646,29654,29679,29692,29694,29702,29706,29709,29723,29726,29748,29758,29759,29760,29762,29780,29790,29821,29830,29833,29837,29848,29849,29851,29893,29895,29896,29899,29902,29932,29935,29940,29959,29963,30017,30042,30049,30054,30069,30078,30097,30114,30117,30119,30143,30153,30190,30191,30204,30209,30220,30224,30228,30236,30237,30247,30260,30265,30276,30302,30320,30344,30356,30363,30394,30401,30403,30429,30442,30453],[13,3,2,7,5,8,8,5,10,4,8,9,8,12,7,2,2,7,24,14,21,8,7,20,14,3,13,3,7,11,13,4,11,17,12,20,16,4,16,13,15,16,10,6,11,9,17,4,2,15,5,17,2,19,10,15,16,8,12,3,7,24,9,2,5,7,17,3,17,4,5,18,3,12,5,7,8,2,5,9,2,8,4,3,17,12,2,15,15,7,12,6,13,15,18,8,25,10,14,9,2,6,10,8,7,2,20,9,5,5,16,9,12,7,6,7,5,2,16,9,2,15,2,10,4,9,11,14,14,16,5,3,12,5,11,5,6,2,3,2,8,7,2,2,20,19,3,14,3,7,23,15,22,16,25,17,14,6,4,11,9,9,11,20,22,3,16,13,19,1,2,3,23,15,10,1,5,12,3,25,12,7,2,11,3,1,24,15,15,8,2,3,25,3,3,7,4,20,13,1,19,9,7,3,8,9,9,2,15,19,7,20,2,14,2,11,6,4,8,3,12,6,3,9,16,13,2,3,2,10,7,9,14,11,16,5,8,12,5,8,13,4,12,2,16,18,15,6,12,4,18,11,13,5,17,2,2,23,6,15,13,3,9,3,15,5,12,7,23,24,7,2,6,5,8,5,5,17,7,5,4,14,15,5,7,15,10,3,6,2,1,3,2,11,13,16,4,8,7,3,6,20,8,12,2,5,18,18,2,9,3,11,5,5,10,7,11,10,6,2,3,4,9,4,3,2,9,12,3,12,1,2,17,6,2,14,3,11,6,20,11,3,19,12,7,4,21,8,7,5,17,20,22,5,8,20,11,8,6,9,4,12,20,1,5,5,18,3,3,8,6,17,10,2,8,4,16,10,18,11,5,2,14,8,14,8,20,11,17,12,7,2,7,1,5,8,3,2,15,5,3,22,19,24,3,2,2,2,3,6,5,2,6,13,4,11,10,10,14,3,8,5,18,15,12,10,5,19,14,9,17,1,10,13,9,8,17,16,2,3,13,3,11,9,5,4,13,10,17,5,9,9,2,4,3,10,22,17,2,20,8,9,7,9,12,8,5,11,6,9,2,2,5,12,2,1,10,9,2,4,3,13,11,11,19,9,7,7,12,13,12,8,12,25,12,10,5,2,3,15,12,13,2,10,8,14,5,2,5,4,11,6,3,11,5,9,17,6,3,3,9,5,24,20,17,9,5,18,2,16,6,6,8,17,5,5,5,5,15,7,3,6,20,5,11,12,5,9,8,7,9,11,12,8,7,12,4,2,5,8,7,6,12,13,14,9,8,16,4,11,4,5,14,2,9,7,5,6,7,7,11,9,3,4,12,12,4,11,2,10,8,5,4,19,15,8,8,23,7,7,8,4,4,11,3,11,23,12,14,6,13,7,13,16,9,6,22,14,2,25,5,10,7,6,3,12,5,7,10,9,5,5,5,7,4,6,3,11,9,8,8,5,4,2,3,1,6,3,9,7,6,14,6,4,3,17,10,22,3,3,6,2,17,7,2,2,4,10,7,5,17,4,8,12,14,8,3,9,7,2,17,8,12,19,1,17,21,7,12,10,3,18,14,5,9,18,10,9,8,20,9,2,9,11,4,3,10,12,11,7,3,2,7,5,2,3,5,6,4,5,10,18,13,8,4,7,19,25,5,5,5,4,11,12,2,4,2,2,6,6,6,5,2,8,6,8,19,6,6,4,19,3,8,9,3,2,11,24,6,8,8,4,4,10,6,15,5,2,21,8,7,5,5,3,4,8,12,18,9,15,4,9,3,3,7,12,9,5,3,12,3,7,12,8,9,3,17,6,14,23,3,13,14,11,8,9,12,7,9,11,5,8,12,5,12,3,9,3,7,7,11,12,18,6,6,6,18,2,8,2,23,8,6,8,2,4,18,14,12,3,8,4,12,16,23,16,11,6,9,4,11,2,3,2,15,23,8,5,3,10,23,2,25,24,6,7,19,10,2,4,13,8,14,3,10,12,20,9,8,7,8,5,23,19,4,2,4,7,16,2,16,7,8,2,9,9,3,16,5,10,17,8,22,7,7,14,5,2,5,5,11,4,9,13,14,15,5,2,6,4,10,12,4,3,21,11,4,12,4,7,6,9,4,4,7,10,7,9,2,5,11,8,15,2,8,5,19,11,15,13,4,10,20,23,16,4,5,8,23,14,5,21,8,5,11,13,13,3,10,21,6,8,77,7,11,1,2,4,4,4,16,14,17,3,4,7,4,12,16,2,19,1,20,25,11,2,25,7,11,8,5,8,12,19,6,10,4,7,10,12,4,9,9,5,5,14,13,8,2,5,11,10,16,7,2,5,13,15,4,15,19,4,9,10,3,3,2,7,9,17,22,5,3,10,9,2,17,9,12,12,20,6,9,5,2,5,2,4,13,7,7,3,10,25,14,12,6,17,2,6,3,8,16,6,6,15,7,26,5,2,16,9,6,4,10,1,12,6,11,17,16,11,3,7,5,2,5,1,5,8,3,8,15,11,1,5,13,7,2,10,4,3,9,11,8,14,1,8,2,15,13,11,9,5,3,7,5,6,8,4,8,8,6,6,2,2,4,2,3,3,7,9,4,4,10,17,14,17,11,19,23,3,4,4,11,15,10,3,2,11,12,12,8,10,5,6,6,4,12,20,7,6,17,17,24,14,5,10,6,1,3,10,2,7,6,4,5,16,17,4,6,12,14,16,6,3,15,14,3,4,4,4,4,15,19,3,4,4,2,2,9,2,17,5,4,13,10,17,6,2,5,9,10,13,6,12,15,3,3,18,13,23,4,5,12,8,8,3,19,2,5,3,3,2,11,15,11,2,12,15,12,7,2,37,3,7,7,2,2,4,4,2,20,22,6,2,14,4,12,9,8,7,7,19,12,2,15,10,7,4,2,11,12,12,12,7,12,21,20,13,9,7,10,8,10,17,4,6,2,17,2,15,3,2,8,3,14,2,3,2,5,12,8,3,25,1,3,8,5,9,12,2,3,5,5,13,11,12,2,6,3,6,5,11,11,13,9,10,18,6,3,12,2,2,2,12,4,5,5,5,9,3,8,15,7,3,9,7,6,20,3,9,9,13,14,6,3,8,7,2,8,4,3,23,6,3,9,10,6,12,16,9,16,8,8,3,5,23,13,5,9,8,5,7,3,12,7,8,10,6,9,3,5,13,4,3,7,4,2,2,7,13,17,7,10,3,5,5,5,3,2,4,8,22,6,2,12,7,14,3,2,4,5,2,6,4,3,6,7,12,4,20,15,7,19,2,7,18,5,9,15,4,10,5,4,3,15,7,5,2,15,6,5,12,3,2,20,2,6,6,5,8,9,12,2,3,17,3,2,7,14,12,8,8,22,9,14,3,5,3,1,12,5],[0,1,0,0,0,3,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,1,1,1,0,1,1,1,0,0,1,1,1,1,0,1,0,0,1,1,0,1,1,1,1,0,1,1,1,1,0,0,1,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,1,0,1,0,1,17,0,0,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,2,1,0,1,0,0,1,1,0,1,1,1,1,0,1,0,0,1,0,1,3,1,0,1,1,1,1,0,1,0,0,0,0,11,1,0,1,1,1,1,1,1,1,0,1,1,1,1,0,0,1,1,0,1,1,1,1,0,1,1,1,1,2,1,1,1,10,1,1,1,1,0,1,1,1,0,0,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,0,0,4,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,0,1,1,1,0,1,1,1,1,0,1,1,9,0,1,1,1,0,1,0,1,1,1,1,0,0,0,0,1,1,1,0,0,1,1,0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,0,1,1,1,0,1,1,2,1,0,1,0,0,0,1,1,1,0,0,1,14,0,1,1,0,0,1,0,1,1,1,0,0,1,0,1,1,1,1,0,0,1,1,1,1,1,1,0,1,0,1,0,0,0,0,1,1,1,1,1,1,1,4,1,1,1,1,1,1,2,1,1,0,1,0,1,1,1,0,0,3,6,1,1,1,0,1,1,1,1,1,0,1,0,1,6,1,1,0,1,1,1,1,1,1,1,1,1,4,1,1,0,9,0,0,1,1,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,3,0,0,1,0,0,0,1,1,1,5,1,1,1,1,1,1,1,1,0,0,0,1,1,0,0,1,0,1,1,0,1,6,1,1,0,0,0,1,1,1,0,0,3,1,0,0,1,0,1,0,0,1,0,0,1,1,1,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,0,1,1,0,0,0,0,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,1,0,1,1,4,1,23,3,1,0,0,1,1,0,1,3,1,1,0,1,0,1,1,1,0,1,1,0,0,1,0,0,0,1,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,1,0,0,0,0,1,1,1,1,1,0,1,1,0,0,0,1,1,1,1,0,1,1,0,0,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1,0,0,0,1,1,1,1,0,3,1,0,1,1,0,1,1,1,0,1,0,0,0,2,0,0,0,0,1,0,0,1,0,0,1,0,1,0,0,0,1,1,0,0,1,0,0,0,1,0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,0,0,0,0,2,0,3,1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,1,1,0,1,1,12,0,1,1,0,1,1,5,0,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,0,1,0,0,1,1,0,0,1,1,1,10,1,0,1,0,6,1,16,1,0,0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,9,1,0,1,0,1,1,1,1,0,0,1,1,1,1,0,7,1,0,1,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,0,0,14,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,0,1,1,0,0,1,0,1,1,1,1,1,1,1,0,1,1,1,1,2,1,0,1,1,13,0,1,0,1,0,1,0,1,1,1,1,0,0,0,1,1,0,1,0,1,1,0,1,1,0,22,0,0,0,0,1,1,1,4,0,4,1,1,0,0,1,0,1,1,0,0,0,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,0,0,0,1,0,0,1,1,0,1,1,1,1,13,1,0,0,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1,0,1,1,0,1,0,1,3,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,3,1,0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0,0,1,1,0,0,1,1,1,1,1,0,2,1,1,0,0,0,0,1,1,1,1,0,0,1,4,1,1,1,1,0,1,1,0,0,0,1,0,0,1,1,1,1,0,0,1,0,1,4,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,4,1,1,7,1,1,1,1,1,1,0,0,1,1,1,1,1,2,0,0,1,1,1,1,1,0,1,1,1,0,1,1,0,0,1,0,0,0,0,0,1,1,0,14,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,1,1,1,1,0,0,1,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0,0,0,1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,0,1,0,1,0,0,1,1,0,1,1,1,1,1,0,0,0,1,0,0,0,1,1,19,0,0,1,0,1,0,1,0,0,1,0,0,1,0,1,1,1,3,0,0,0,0,1,1,0,1,0,0,1,1,0,0,1,1,0,5,0,3,0,1,1,0,0,0,1,0,1,0,1,0,1,0,1,1,0,0,1,0,1,1,1,5,0,0,1,0,1,1,0,0,0,1,1,1,0,1,1,1,0,1,0,0,1,1,1,1,0,0,1,0,0,0,0,1,1,1,1,6,1,1,1,0,0,0,1,1,1,1,1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1,1,1,18,1,0,0,1,5,1,1,1,0,1,1,1,0,1,1,1,1,1,1,0,0,1,0,1,0,1,1,0,1,0,2,1,1,1,2,1,0,0,1,1,1,1,1,1,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>floor<\/th>\n      <th>max_floor<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<!--/html_preserve-->
There are 1,493 observations where this is the case.

Demographic Characteristics
---------------------------

Now let's move beyond the internal home characteristics and take a look at some of the basic demographic and geographic characteristics. First, the correlation plot.

``` r
demo_vars <- c('area_m', 'raion_popul', 'full_all', 'male_f', 'female_f', 'young_all',
'young_female', 'work_all', 'work_male', 'work_female', 'price_doc')

corrplot(cor(dtrain[, ..demo_vars], use='complete.obs'))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-26-1.png)

Price is correlated with most of these, but the associations are fairly weak. First I'll check out the sub\_area feature. According to the data dictionary, this is the district that the home is located in.

``` r
# How many unique districts are there?
length(unique(dtrain$sub_area))
```

    ## [1] 146

I want to calculate population density and check to see if its correlated with price. The area\_m feature appears to be the area (in square meters) of the sub area. As I understand it, Moscow is divided into okrugs that are further divided into raions. These raions are the areas named in the sub\_area column. Let's divide area\_m (in sq meters) by 1000000 to get the sub\_area area in square kilometers. Then we will divide raion\_popul by area\_km to get the population density for the raion. To verify that these are correct, I've cross-checked these numbers [here.](https://www.citypopulation.de/)

``` r
dtrain %>%
mutate(area_km=area_m/1000000, density=raion_popul/area_km) %>%
select(sub_area, density, price_doc) %>%
group_by(sub_area) %>%
summarize(density=median(density), med_price=median(price_doc)) %>%
ggplot(aes(x=density, y=med_price)) +
geom_point(color='grey') +
geom_smooth(method='lm', color='red') +
ggtitle('Median home price by raion population density (people per sq. km)')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-28-1.png)

These density numbers seem to make sense given that the population density of Moscow as a whole is 8,537/sq km. There are a few raions that seem to have a density of near zero, which seems odd. Home price does seem to increase with population density.

Let's get an idea of how many sales transactions are in each district:

``` r
dtrain %>%
group_by(sub_area) %>%
summarize(n=n()) %>%
ggplot(aes(x=reorder(sub_area, n), y=n)) +
geom_bar(stat='identity') +
coord_flip() +
labs(y='Number of transactions', x='', title='Number of Transactions by District')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-29-1.png)

Poselenie Sosenskoe, Nekrasovka, Poselenie Vnukovskoe had the most transactions in the data set by a fairly large margin.

I wonder if there is a relationship between the share of the population that is working age and price.

``` r
dtrain %>%
mutate(work_share=work_all/raion_popul) %>%
group_by(sub_area) %>%
summarize(mean_price=mean(price_doc), work_share=mean(work_share)) %>%
ggplot(aes(x=work_share, y=mean_price)) +
geom_point(color='red') +
geom_smooth(color='gray') +
ggtitle('District mean home price by share of working age population')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-30-1.png)

There does not appear to be a relationship between the mean home price in a district and the district's share of working age population.

School Characteristics
----------------------

In the US, school quality is one of the primary determinants of home values. Let's see if something similar is true in Russia.

``` r
school_chars <- c('children_preschool', 'preschool_quota', 'preschool_education_centers_raion',
'children_school', 'school_quota', 'school_education_centers_raion',
'school_education_centers_top_20_raion', 'university_top_20_raion',
'additional_education_raion', 'additional_education_km', 'university_km',
'price_doc')

corrplot(cor(dtrain[, ..school_chars], use='complete.obs'))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-31-1.png)

Surprisingly, there is little to no correlation between price and the school variables. The school variables however are highly correlated with each other, indicating that we would not want to use all of them in a linear regression model due to multicollinearity.

The one variable that does show some correlation is university\_top\_20\_raion. Let's look at it:

``` r
table(dtrain$university_top_20_raion)
```

    ## 
    ##     0     1     2     3 
    ## 27392  1994  1035    50

``` r
dtrain %>%
ggplot(aes(x=as.factor(university_top_20_raion), y=price_doc)) +
geom_jitter(color='grey') +
geom_boxplot(fill='red', color='gray', alpha=0.5) +
ggtitle('Distribution of home price by # of top universities in Raion')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-33-1.png)

Homes in a raion with 3 top 20 universities have the highest median home price, however, it is fairly close among 0, 1, and 2. There are very few homes with 3 top universites in their raion. Let's see how many districts there are with three universities.

``` r
unique(dtrain %>% filter(university_top_20_raion==3) %>% select(sub_area))
```

    ##         sub_area
    ## 1 Zamoskvorech'e

Just one.

I plan on adding a lot more to this section soon. Please check back!

Cultural/Recreational Characteristics
-------------------------------------

``` r
cult_chars <- c('sport_objects_raion', 'culture_objects_top_25_raion', 'shopping_centers_raion',                        'park_km', 'fitness_km', 'swim_pool_km', 'ice_rink_km','stadium_km', 'basketball_km',                   'shopping_centers_km', 'big_church_km','church_synagogue_km', 'mosque_km', 'theater_km',                 'museum_km', 'exhibition_km', 'catering_km', 'price_doc')

corrplot(cor(dtrain[, ..cult_chars], use='complete.obs'))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-35-1.png)

There are weak correlations between price and many of these variables. There is a small positive correlation between price and the number of 'sports objects' in a raion as well as between price and the number of shopping centers. As expected, there is also a negative correlation between price and the (nearest?) of the cultural and recreational amenities.

Let's look at sport\_objects.

``` r
dtrain %>%
group_by(sub_area) %>%
summarize(sport_objects=mean(sport_objects_raion), med_price=median(price_doc)) %>%
ggplot(aes(x=sport_objects, y=med_price)) +
geom_point(color='grey') +
geom_smooth(method='lm', color='red') +
ggtitle('Median Raion home price by # of sports objects in Raion')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-36-1.png)

There is definitely a positive correlation. This could be a good candidate feature to include in a model.

Let's do the same for culture objects.

``` r
dtrain %>%
group_by(sub_area) %>%
summarize(culture_objects=mean(culture_objects_top_25_raion), med_price=median(price_doc)) %>%
ggplot(aes(x=culture_objects, y=med_price)) +
geom_point(color='grey') +
geom_smooth(method='lm', color='red') +
ggtitle('Median raion home price by # of culture objects in raion')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-37-1.png)

We can't get much information out of this due to the large number of raions that have zero culture objects. What if we just see if there is a difference between raions with and raions without a top 25 culture object.

``` r
dtrain %>% group_by(culture_objects_top_25) %>%
summarize(med_price=median(price_doc))
```

    ## # A tibble: 2 x 2
    ##   culture_objects_top_25 med_price
    ##                   <fctr>     <dbl>
    ## 1                     no   6200000
    ## 2                    yes   7400000

So raions that have a top 25 cultural object have a median home sale price that is higher by 1.2 million.

How is the distance to the nearest park related to home price?

``` r
ggplot(aes(x=park_km, y=price_doc), data=dtrain) +
geom_point(color='red', alpha=0.4) +
geom_smooth(method='lm', color='grey') +
ggtitle('Home price by distance to nearest park')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-39-1.png)

I plan on adding a lot more to this section soon. Please check back!

Infrastructure Features
-----------------------

``` r
inf_features <- c('nuclear_reactor_km', 'thermal_power_plant_km', 'power_transmission_line_km',
'incineration_km','water_treatment_km', 'incineration_km', 'railroad_station_walk_km',                   'railroad_station_walk_min', 'railroad_station_avto_km', 'railroad_station_avto_min',                    'public_transport_station_km', 'public_transport_station_min_walk', 'water_km',                          'mkad_km', 'ttk_km', 'sadovoe_km','bulvar_ring_km', 'kremlin_km', 'price_doc')

corrplot(cor(dtrain[, ..inf_features], use='complete.obs'))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-40-1.png)

``` r
ggplot(aes(x=kremlin_km, y=price_doc), data=dtrain) +
geom_point(color='grey') +
geom_smooth(method='lm', color='red') +
ggtitle('Home price by distance to Kremlin')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-41-1.png)

I plan on adding a lot more to this section soon. Please check back!

Variable Importance
-------------------

Now I am going to run a quick random forest model on dtrain so that we can use the resulting variable importance values. In order to avoid having to impute missing data right now, I am going to subset dtrain to only include those observations that have values for every variable. This is about 6000 samples, or about 1/5th of the full data set. This should be a large enough sample just to get a rough idea of what variables have the most predictive power.

``` r
library(caret)
library(randomForest)

#Get complete cases of dtrain
completes <- complete.cases(dtrain)

# Set training control so that we only 1 run forest on the entire set of complete cases
trControl <- trainControl(method='none')

# Run random forest on complete cases of dtrain. Exclude incineration_raion since it
# only has 1 factor level
rfmod <- train(price_doc ~ . - id - timestamp - incineration_raion,
method='rf',
data=dtrain[completes, ],
trControl=trControl,
tuneLength=1,
importance=TRUE)

varImp(rfmod)
```

Not surprisingly, the variables concerning the size of the home, such as area and number of rooms, have the highest importance. The number of stories in the building seems to be quite important as well. Build year ranks high. Surprisingly, the distance to the nearest basketball court ranks high as well.

Train vs Test Data
==================

There has been a lot of discussion in the forums about the test data for this competition having significantly different distributions for some of the features. This can cause a significant disparity between local cross-validation scores and leaderboard scores. Let's see what we can find out.

``` r
dtest <- fread('../data/test.csv', stringsAsFactors=TRUE)
```

Missing Data
------------

First of all, let's see how much of the test data is missing.

``` r
miss_pct <- map_dbl(dtest, function(x) { round((sum(is.na(x)) / length(x)) * 100, 1) })

miss_pct <- miss_pct[miss_pct > 0]

data.frame(miss=miss_pct, var=names(miss_pct), row.names=NULL) %>%
ggplot(aes(x=reorder(var, -miss), y=miss)) +
geom_bar(stat='identity', fill='red') +
labs(x='', y='% missing', title='Percent missing data by feature') +
theme(axis.text.x=element_text(angle=90, hjust=1))
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-44-1.png)

In order to most effectively plot the train and test set features, I am going to stack the two data sets and add a dummy variable indicating whether the observation row is in the train or test set.

``` r
dtrain <- dtrain %>%
# remove price_doc from dtrain
select(-price_doc) %>%
mutate(dataset='train')

dtest <- dtest %>%
mutate(dataset='test', timestamp=as.Date(timestamp, format = "%m/%d/%Y"))

all_data <- bind_rows(dtrain, dtest)
```

Internal Home Features
----------------------

``` r
all_data %>%
ggplot(aes(x=full_sq)) +
geom_density(color='red', fill='red', alpha=0.7) +
facet_wrap(~as.factor(dataset)) +
scale_x_continuous(trans='log') +
ggtitle('Distribution of full_sq')
```

    ## Warning: Transformation introduced infinite values in continuous x-axis

    ## Warning: Removed 3 rows containing non-finite values (stat_density).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-46-1.png)

``` r
all_data %>%
ggplot(aes(x=life_sq)) +
geom_density(color='red', fill='red', alpha=0.7) +
facet_wrap(~as.factor(dataset)) +
scale_x_continuous(trans='log') +
ggtitle('Distribution of life_sq')
```

    ## Warning: Transformation introduced infinite values in continuous x-axis

    ## Warning: Removed 7608 rows containing non-finite values (stat_density).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-47-1.png)

``` r
all_data %>%
ggplot(aes(x=kitch_sq)) +
geom_density(color='red', fill='red', alpha=0.7) +
facet_wrap(~as.factor(dataset)) +
scale_x_continuous(trans='log') +
ggtitle('Distribution of kitch_sq')
```

    ## Warning: Transformation introduced infinite values in continuous x-axis

    ## Warning: Removed 11329 rows containing non-finite values (stat_density).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-48-1.png)

It seems that the distributions of the three area features are distributing similarly between the train and test sets. What about the number of rooms?

``` r
all_data %>%
ggplot(aes(x=num_room)) +
geom_histogram(fill='red') +
facet_wrap(~dataset) +
ggtitle('Distribution of number of rooms')
```

    ## Warning: Removed 9572 rows containing non-finite values (stat_bin).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-49-1.png)

What about floor and max\_floor?

``` r
all_data %>%
ggplot(aes(x=floor)) +
geom_density(color='red', fill='red') +
facet_wrap(~dataset)
```

    ## Warning: Removed 167 rows containing non-finite values (stat_density).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-50-1.png)

``` r
all_data %>%
ggplot(aes(x=max_floor)) +
geom_density(color='red', fill='red') +
facet_wrap(~dataset)
```

    ## Warning: Removed 9572 rows containing non-finite values (stat_density).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-51-1.png)

Looks good. Now we'll again look at the floor and max\_floor data to check where floor is greater than max\_floor.

``` r
all_data %>%
ggplot(aes(x=floor, y=max_floor)) +
geom_point(color='red') +
geom_abline(intercept=0, slope=1, color='darkgrey') +
facet_wrap(~dataset) +
ggtitle('Max floor by floor')
```

    ## Warning: Removed 9572 rows containing missing values (geom_point).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-52-1.png)

The structure of the bad data seems to have the same proportions across train and test. It may be worth taking a deeper look at the structure of the erroneous floor data to see if there is any structure.

Next, let's see how the number of transactions varies across the entire train and test set.

``` r
all_data %>%
ggplot(aes(x=timestamp, fill=dataset, color=dataset)) +
geom_bar(alpha=0.7) +
scale_fill_manual(values=c('red', 'darkgrey')) +
scale_color_manual(values=c('red', 'darkgrey')) +
ggtitle('Number of transactions by day')
```

    ## Warning: Removed 7662 rows containing non-finite values (stat_count).

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-53-1.png)

The test set directly follows the train set in time. There does not appear to be any major discrepancy between the distributions of the daily transaction counts between test and train.

How sales distributed across the two types in product\_type?

``` r
ggplot(aes(x=product_type),data=all_data) +
geom_bar(fill='red') +
facet_grid(~dataset)
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-54-1.png)

The test set has a small number of missing values for product\_type. As a basic imputation strategy, we could replace these with 'Investment', since this is the most common type.

How do the sales counts vary by home state across the train and test sets?

``` r
all_data %>%
ggplot(aes(x=as.factor(state), fill=as.factor(state))) +
geom_bar() +
facet_wrap(~dataset) +
ggtitle('Distribution of state')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-55-1.png)

Interestingly, the train set has a much higher proportion of missing data for this feature than does the test set.

Now let's do the same for material.

``` r
all_data %>%
ggplot(aes(x=as.factor(material), fill=as.factor(material))) +
geom_bar() +
facet_wrap(~dataset) +
ggtitle('Distribution of material')
```

![](Russian_Housing_files/figure-markdown_github/unnamed-chunk-56-1.png)

The distributions of material seem mostly evenly distributed across test and train. The exception is the NAs. train.csv has a large number of missing values whereas test does not.

I plan on adding more this this section soon. Please check back!
